
@{
    ViewBag.Title = "Chat";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>My Chat</h2>
<h3>Welcome, <i style="color:green" id="fromUser"></i> >> <i style="color:mediumblue" id="toUser"></i></h3>
<div>
    <div id="group" style="float:right">
        <h3>List of Users</h3>
        <ol id="listUserGroup"></ol>
        <input type="hidden" id="listUserGroupH" />
    </div>
    <div id="chat">
        <ul id="discussion"></ul>
        <input type="text" id="message" /><input type="button" id="sendmessage" value="Send" /><input type="file" id="file" />
    </div>
</div>
@section scripts {

}

<!--Script references. -->
<script src="~/Scripts/jquery-3.3.1.min.js"></script>
<!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
<!--Reference the SignalR library. -->
@*<script src="~/Scripts/jquery.signalR-2.1.0.min.js"></script>*@
<script src="~/Scripts/jquery.signalR-2.2.2.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<!--SignalR script to update the chat page and send messages.-->
<script>
    $(function () {
        // Reference the auto-generated proxy for the hub.
        var chat = $.connection.chatHub;
        // Create a function that the hub can call back to display messages.
        chat.client.addNewMessageToPage = function (fromName, toName, message, path, time) {
            // Add the message to the page.
            var a = '';
            if (path !== null && path !== '') {
                a = '<a href="' + path + '" target="_blank"><i>attachment</i></a>';
            }
            //var strDate = convertToDate(time);
            $('#discussion').append('<li><strong>' + htmlEncode(fromName) + '</strong>: ' + htmlEncode(message) + ' | ' + a + ' | ' + htmlEncode(time) + '</li>');
        };
        checkUser();
        // Set initial focus to message input box.
        $('#message').focus();
        // Start the connection.
        $.connection.hub.start().done(function () {
            $('#sendmessage').click(function () {
                var fileName = uploadFile();
                var filePath = '';
                if (fileName !== undefined) {
                    filePath = '/MyFiles/' + fileName;
                }
                // Call the Send method on the hub.
                chat.server.send($('#fromUser').text(), $('#toUser').text(), $('#message').val(), filePath, '');
                // Clear text box and reset focus for next comment.
                $('#message').val('').focus();
            });
        });
    });

    function checkUser() {
        var isLogin = localStorage.getItem('isLogin');
        if (isLogin === undefined || isLogin === null || isLogin === '') {
            // Get the user name and store it to prepend to messages.
            $('#fromUser').text(prompt('Enter your name:', ''));
            login($('#fromUser').text());
        } else {
            $('#fromUser').text(isLogin);
            getUserGroup(isLogin);
        }
    }

    // This optional function html-encodes messages for display in the page.
    function htmlEncode(value) {
        var encodedValue = $('<div />').text(value).html();
        return encodedValue;
    }

    function uploadFile() {
        const files = document.getElementById('file').files;
        if (files != null && files.length > 0) {
            const url = "/Home/UploadFile";
            const formData = new FormData();
            formData.append('file', files[0]);
            // post form data
            const xhr = new XMLHttpRequest();
            // create and send the reqeust
            xhr.open('POST', url);
            xhr.send(formData);
            return files[0].name;
        }
    }

    function login(username) {
        var http = new XMLHttpRequest();
        var url = '/Home/Login';
        var params = 'username=' + username;
        http.open('POST', url, true);
        //Send the proper header information along with the request
        http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        http.onreadystatechange = function () {//Call a function when the state changes.
            if (http.readyState == 4 && http.status == 200) {
                var res = JSON.parse(http.responseText);
                if (res.message !== 'SUCCESS') {
                    window.location = '/Home/Index';
                } else {
                    localStorage.setItem('isLogin', username);
                    window.location = '/Home/Chat';
                }
            }
        }
        http.send(params);
    }

    function getUserGroup(username) {
        var http = new XMLHttpRequest();
        var url = '/Home/GetUserGroup';
        var params = 'username=' + username;
        http.open('POST', url, true);
        //Send the proper header information along with the request
        http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        http.onreadystatechange = function () {//Call a function when the state changes.
            if (http.readyState == 4 && http.status == 200) {
                var res = JSON.parse(http.responseText);
                var listUserGroup = res.data;
                $('#listUserGroupH').val(JSON.stringify(listUserGroup));
                for (var i = 0; i < listUserGroup.length; i++) {
                    if (listUserGroup[i].UserGroupName !== $('#fromUser').text()) {
                        $('#listUserGroup').append('<li><a href="#" onclick="chooseUserGroup(' + listUserGroup[i].ID + ')">' + htmlEncode(listUserGroup[i].UserGroupName) + '</a></li>');
                    }
                }
            }
        }
        http.send(params);
    }

    function chooseUserGroup(ID) {
        var listUserGroupH = $('#listUserGroupH').val();
        var listUserGroup = JSON.parse(listUserGroupH);
        for (var i = 0; i < listUserGroup.length; i++) {
            if (listUserGroup[i].ID === ID) {
                $('#toUser').text(listUserGroup[i].UserGroupName);
                loadMessage();
            }
        }
    }

    function loadMessage() {
        $('#discussion').text('');
        var fromUser = $('#fromUser').text();
        var toUser = $('#toUser').text();
        var http = new XMLHttpRequest();
        var url = '/Home/GetMessage';
        var params = 'fromUser=' + fromUser + '&toUser=' + toUser;
        http.open('POST', url, true);
        //Send the proper header information along with the request
        http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        http.onreadystatechange = function () {//Call a function when the state changes.
            if (http.readyState == 4 && http.status == 200) {
                var res = JSON.parse(http.responseText);
                var listMessage = res.data;
                for (var i = 0; i < listMessage.length; i++) {
                    var path = listMessage[i].FilePath;
                    var a = '';
                    if (path !== null && path !== '') {
                        a = '<a href="' + path + '" target="_blank"><i>attachment</i></a>';
                    }
                    var strDate = convertToDate(listMessage[i].MessageTime);
                    $('#discussion').append('<li><strong>' + htmlEncode(listMessage[i].Sender) + '</strong>: ' + htmlEncode(listMessage[i].Text) + ' | ' + a + ' | ' + htmlEncode(strDate) + '</li>');
                }
            }
        }
        http.send(params);
    }

    function convertToDate(strDate) {
        var d = new Date();
        var strTime = strDate.substring(6, 19);
        var nTime = parseInt(strTime);
        d = new Date(nTime);
        return d;
    }

</script>